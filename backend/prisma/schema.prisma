generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String         @id @default(cuid())
  phone         String         @unique
  countryCode   String         @default("+91")
  isVerified    Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  business      Business?
  refreshTokens RefreshToken[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model OTP {
  id        String   @id @default(cuid())
  phone     String
  code      String
  expiresAt DateTime
  attempts  Int      @default(0)
  createdAt DateTime @default(now())

  @@index([phone, code])
  @@map("otps")
}

model Business {
  id                 String     @id @default(cuid())
  userId             String     @unique
  name               String
  legalName          String?
  gstin              String?    @unique
  pan                String?
  addressLine1       String?
  addressLine2       String?
  city               String?
  state              String?
  pincode            String?
  country            String     @default("India")
  email              String?
  phone              String?
  website            String?
  logoUrl            String?
  upiId              String?
  bankName           String?
  bankAccountNo      String?
  bankIfsc           String?
  invoicePrefix      String     @default("INV")
  invoiceNextNumber  Int        @default(1)
  termsAndConditions String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  user               User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  customers          Customer[]
  invoices           Invoice[]
  products           Product[]
  reminders          Reminder[]
  templates          Template[]

  @@map("businesses")
}

model Customer {
  id           String      @id @default(cuid())
  businessId   String
  name         String
  phone        String?
  email        String?
  gstin        String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  pincode      String?
  country      String      @default("India")
  billingType  BillingType @default(INTRA_STATE)
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  business     Business    @relation(fields: [businessId], references: [id], onDelete: Cascade)
  invoices     Invoice[]
  reminders    Reminder[]

  @@index([businessId, name])
  @@map("customers")
}

model Product {
  id           String        @id @default(cuid())
  businessId   String
  name         String
  description  String?
  hsnCode      String?
  unit         String        @default("pcs")
  price        Decimal       @db.Decimal(10, 2)
  gstRate      Decimal       @default(18) @db.Decimal(5, 2)
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  invoiceItems InvoiceItem[]
  business     Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, name])
  @@map("products")
}

model Invoice {
  id                 String        @id @default(cuid())
  businessId         String
  customerId         String
  invoiceNumber      String
  invoiceDate        DateTime      @default(now())
  dueDate            DateTime?
  subtotal           Decimal       @db.Decimal(12, 2)
  discountType       DiscountType  @default(NONE)
  discountValue      Decimal       @default(0) @db.Decimal(10, 2)
  discountAmount     Decimal       @default(0) @db.Decimal(12, 2)
  taxableAmount      Decimal       @db.Decimal(12, 2)
  cgstAmount         Decimal       @default(0) @db.Decimal(12, 2)
  sgstAmount         Decimal       @default(0) @db.Decimal(12, 2)
  igstAmount         Decimal       @default(0) @db.Decimal(12, 2)
  totalGst           Decimal       @db.Decimal(12, 2)
  grandTotal         Decimal       @db.Decimal(12, 2)
  amountPaid         Decimal       @default(0) @db.Decimal(12, 2)
  balanceDue         Decimal       @db.Decimal(12, 2)
  status             InvoiceStatus @default(DRAFT)
  paymentStatus      PaymentStatus @default(UNPAID)
  pdfUrl             String?
  notes              String?
  termsAndConditions String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  items              InvoiceItem[]
  business           Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer           Customer      @relation(fields: [customerId], references: [id])
  payments           Payment[]

  @@unique([businessId, invoiceNumber])
  @@index([businessId, status])
  @@index([businessId, paymentStatus])
  @@map("invoices")
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  productId   String?
  name        String
  description String?
  hsnCode     String?
  quantity    Decimal  @db.Decimal(10, 3)
  unit        String   @default("pcs")
  rate        Decimal  @db.Decimal(10, 2)
  gstRate     Decimal  @db.Decimal(5, 2)
  amount      Decimal  @db.Decimal(12, 2)
  cgstAmount  Decimal  @default(0) @db.Decimal(12, 2)
  sgstAmount  Decimal  @default(0) @db.Decimal(12, 2)
  igstAmount  Decimal  @default(0) @db.Decimal(12, 2)
  totalAmount Decimal  @db.Decimal(12, 2)
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product     Product? @relation(fields: [productId], references: [id])

  @@map("invoice_items")
}

model Payment {
  id            String        @id @default(cuid())
  invoiceId     String
  amount        Decimal       @db.Decimal(12, 2)
  paymentDate   DateTime      @default(now())
  paymentMethod PaymentMethod @default(CASH)
  reference     String?
  notes         String?
  createdAt     DateTime      @default(now())
  invoice       Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Reminder {
  id          String         @id @default(cuid())
  businessId  String
  customerId  String?
  title       String
  description String?
  remindAt    DateTime
  type        ReminderType   @default(CUSTOM)
  status      ReminderStatus @default(PENDING)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  business    Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer    Customer?      @relation(fields: [customerId], references: [id])

  @@index([businessId, status, remindAt])
  @@map("reminders")
}

model Template {
  id         String    @id @default(cuid())
  businessId String?
  name       String
  content    String
  variables  String[]  @default([])
  isDefault  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  business   Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@map("templates")
}

enum BillingType {
  INTRA_STATE
  INTER_STATE
}

enum DiscountType {
  NONE
  PERCENTAGE
  FLAT
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
  OVERDUE
}

enum PaymentMethod {
  CASH
  UPI
  BANK_TRANSFER
  CHEQUE
  CARD
  OTHER
}

enum ReminderType {
  PAYMENT_DUE
  FOLLOW_UP
  CUSTOM
}

enum ReminderStatus {
  PENDING
  COMPLETED
  SNOOZED
  CANCELLED
}
